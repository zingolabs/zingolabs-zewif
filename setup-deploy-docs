#!/usr/bin/env bash
#
# Oneâ€‘time setup: create and push an initial ghâ€‘pages branch containing
# `cargo doc` output for the current Rust crate repository.
#
# After this, use the deploy script for subsequent updates.

set -euo pipefail

REPO_URL="$(git remote get-url origin)"
DEPLOY_DIR="/tmp/cargo-doc-setup"
TARGET_DIR=${CARGO_TARGET_DIR:-$(cargo metadata --format-version 1 --no-deps | jq -r '.target_directory')}
CRATE_DIR=${CARGO_MANIFEST_DIR:-$(pwd)}
CRATE_NAME=${CARGO_PKG_NAME:-$(grep -m1 '^name' Cargo.toml | sed -E 's/name *= *"(.*)".*/\1/')}
DOC_DIR="$TARGET_DIR/doc/$CRATE_NAME"

# â”€â”€ Sanity checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo 'âŒ Error: not inside a Git repository.'
  exit 1
fi

if git ls-remote --exit-code --heads origin gh-pages >/dev/null; then
  echo 'âŒ origin/gh-pages already exists. Run the regular deploy script instead.'
  exit 1
fi

# â”€â”€ Build documentation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo 'ðŸ“š Building documentationâ€¦'
RUSTDOCFLAGS="-Z unstable-options --static-root-path=static.files/" \
    cargo +nightly doc --no-deps --all-features

# â”€â”€ Prepare temporary gh-pages worktree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rm -rf "$DEPLOY_DIR"
mkdir -p "$DEPLOY_DIR"
pushd "$DEPLOY_DIR" >/dev/null

git init
git checkout --orphan gh-pages

# Copy resources in
cp -R "$TARGET_DIR/doc/static.files/" "$DEPLOY_DIR/static.files/"
# Copy docs in, preserving subdirs
cp -R "$TARGET_DIR/doc/$CRATE_NAME/" "$DEPLOY_DIR/"
touch .nojekyll
[[ -f "$CRATE_DIR/CNAME" ]] && cp "$CRATE_DIR/CNAME" .

# open $DEPLOY_DIR
# exit 0

git add .
git commit -m "Initial deploy of $CRATE_NAME documentation"
git remote add origin "$REPO_URL"
git push -u origin gh-pages

popd >/dev/null
rm -rf "$DEPLOY_DIR"

echo "âœ… GitHub Pages branch 'gh-pages' created and published."
echo "ðŸ‘‰ In your repo settings â†’ Pages, set source to the 'gh-pages' branch, root directory."
