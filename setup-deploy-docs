#!/usr/bin/env bash
#
# Oneâ€‘time setup: create and push an initial ghâ€‘pages branch containing
# `cargo doc` output for the current Rust crate repository.
#
# After this, use the deploy script for subsequent updates.

set -euo pipefail

REPO_URL="$(git remote get-url origin)"
DEPLOY_DIR="/tmp/cargo-doc-setup"
DOC_DIR="cargo-docs"

# â”€â”€ Sanity checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo 'âŒ Error: not inside a Git repository.'
  exit 1
fi

if git ls-remote --exit-code --heads origin gh-pages >/dev/null; then
  echo 'âŒ origin/gh-pages already exists. Run the regular deploy script instead.'
  exit 1
fi

# â”€â”€ Build documentation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo 'ðŸ“š Building documentationâ€¦'
cargo doc --all-features --no-deps

# â”€â”€ Determine crate name and create root redirect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CRATE_NAME=$(grep -m1 '^name' Cargo.toml | sed -E 's/name *= *"(.*)".*/\1/')
cat >"$DOC_DIR/index.html" <<EOF
<!DOCTYPE html><html lang="en"><head>
<meta http-equiv="refresh" content="0; url=${CRATE_NAME}/index.html">
<title>Redirecting to ${CRATE_NAME} docsâ€¦</title>
</head><body></body></html>
EOF

# â”€â”€ Prepare temporary gh-pages worktree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rm -rf "$DEPLOY_DIR"
mkdir -p "$DEPLOY_DIR"
pushd "$DEPLOY_DIR" >/dev/null

git init
git checkout --orphan gh-pages

# Copy docs in, preserving subdirs
cp -R "$OLDPWD/$DOC_DIR/"* .
touch .nojekyll
[[ -f "$OLDPWD/CNAME" ]] && cp "$OLDPWD/CNAME" .

git add .
git commit -m "Initial deploy of $CRATE_NAME documentation"
git remote add origin "$REPO_URL"
git push -u origin gh-pages

popd >/dev/null
rm -rf "$DEPLOY_DIR"

echo "âœ… GitHub Pages branch 'gh-pages' created and published."
echo "ðŸ‘‰ In your repo settings â†’ Pages, set source to the 'gh-pages' branch, root directory."
